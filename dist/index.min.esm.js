function t(t){if(this.words=[],t)if(Symbol&&Symbol.iterator&&void 0!==t[Symbol.iterator])for(var s=t[Symbol.iterator](),r=s.next();!r.done;)this.add(r.value),r=s.next();else for(var o=0;o<t.length;o++)this.add(t[o])}t.prototype.add=function(t){this.resize(t),this.words[t>>>5]|=1<<t},t.prototype.flip=function(t){this.resize(t),this.words[t>>>5]^=1<<t},t.prototype.clear=function(){this.words=[]},t.prototype.remove=function(t){this.resize(t),this.words[t>>>5]&=~(1<<t)},t.prototype.isEmpty=function(t){for(var s=this.words.length,r=0;r<s;r++)if(0!==this.words[r])return!1;return!0},t.prototype.has=function(t){return 0!=(this.words[t>>>5]&1<<t)},t.prototype.checkedAdd=function(t){this.resize(t);var s=this.words[t>>>5],r=s|1<<t;return this.words[t>>>5]=r,(r^s)>>>t},t.prototype.trim=function(t){for(var s=this.words.length;s>0&&0===this.words[s-1];)s--;this.words=this.words.slice(0,s)},t.prototype.resize=function(t){for(var s=t+32>>>5,r=this.words.length;r<s;r++)this.words[r]=0},t.prototype.hammingWeight=function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},t.prototype.hammingWeight4=function(t,s,r,o){return 16843009*((t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)+(s=(s=(858993459&(s-=s>>>1&1431655765))+(s>>>2&858993459))+(s>>>4)&252645135)+(r=(r=(858993459&(r-=r>>>1&1431655765))+(r>>>2&858993459))+(r>>>4)&252645135)+(o=(o=(858993459&(o-=o>>>1&1431655765))+(o>>>2&858993459))+(o>>>4)&252645135))>>>24},t.prototype.size=function(){for(var t=0,s=this.words.length,r=this.words,o=0;o<s;o++)t+=this.hammingWeight(r[o]);return t},t.prototype.array=function(){for(var t=new Array(this.size()),s=0,r=this.words.length,o=0;o<r;++o)for(var e=this.words[o];0!=e;){var i=e&-e;t[s++]=(o<<5)+this.hammingWeight(i-1|0),e^=i}return t},t.prototype.forEach=function(t){for(var s=this.words.length,r=0;r<s;++r)for(var o=this.words[r];0!=o;){var e=o&-o;t((r<<5)+this.hammingWeight(e-1|0)),o^=e}},t.prototype[Symbol.iterator]=function*(){for(var t=this.words.length,s=0;s<t;++s)for(var r=this.words[s];0!=r;){var o=r&-r;yield(s<<5)+this.hammingWeight(o-1|0),r^=o}},t.prototype.clone=function(){var s=Object.create(t.prototype);return s.words=this.words.slice(),s},t.prototype.intersects=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0;r<s;++r)if(0!=(this.words[r]&t.words[r]))return!0;return!1},t.prototype.intersection=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0;r+7<s;r+=8)this.words[r]&=t.words[r],this.words[r+1]&=t.words[r+1],this.words[r+2]&=t.words[r+2],this.words[r+3]&=t.words[r+3],this.words[r+4]&=t.words[r+4],this.words[r+5]&=t.words[r+5],this.words[r+6]&=t.words[r+6],this.words[r+7]&=t.words[r+7];for(;r<s;++r)this.words[r]&=t.words[r];var o=this.words.length;for(r=s;r<o;++r)this.words[r]=0;return this},t.prototype.intersection_size=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0,o=0;o<s;++o)r+=this.hammingWeight(this.words[o]&t.words[o]);return r},t.prototype.new_intersection=function(s){var r=Object.create(t.prototype),o=Math.min(this.words.length,s.words.length);r.words=new Array(o);for(var e=o,i=0;i+7<e;i+=8)r.words[i]=this.words[i]&s.words[i],r.words[i+1]=this.words[i+1]&s.words[i+1],r.words[i+2]=this.words[i+2]&s.words[i+2],r.words[i+3]=this.words[i+3]&s.words[i+3],r.words[i+4]=this.words[i+4]&s.words[i+4],r.words[i+5]=this.words[i+5]&s.words[i+5],r.words[i+6]=this.words[i+6]&s.words[i+6],r.words[i+7]=this.words[i+7]&s.words[i+7];for(;i<e;++i)r.words[i]=this.words[i]&s.words[i];return r},t.prototype.equals=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0;r<s;++r)if(this.words[r]!=t.words[r])return!1;if(this.words.length<t.words.length){var o=t.words.length;for(r=this.words.length;r<o;++r)if(0!=t.words[r])return!1}else if(t.words.length<this.words.length)for(o=this.words.length,r=t.words.length;r<o;++r)if(0!=this.words[r])return!1;return!0},t.prototype.difference=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0;r+7<s;r+=8)this.words[r]&=~t.words[r],this.words[r+1]&=~t.words[r+1],this.words[r+2]&=~t.words[r+2],this.words[r+3]&=~t.words[r+3],this.words[r+4]&=~t.words[r+4],this.words[r+5]&=~t.words[r+5],this.words[r+6]&=~t.words[r+6],this.words[r+7]&=~t.words[r+7];for(;r<s;++r)this.words[r]&=~t.words[r];return this},t.prototype.new_difference=function(t){return this.clone().difference(t)},t.prototype.difference_size=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0,o=0;o<s;++o)r+=this.hammingWeight(this.words[o]&~t.words[o]);for(var e=this.words.length;o<e;++o)r+=this.hammingWeight(this.words[o]);return r},t.prototype.change=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0;r+7<s;r+=8)this.words[r]^=t.words[r],this.words[r+1]^=t.words[r+1],this.words[r+2]^=t.words[r+2],this.words[r+3]^=t.words[r+3],this.words[r+4]^=t.words[r+4],this.words[r+5]^=t.words[r+5],this.words[r+6]^=t.words[r+6],this.words[r+7]^=t.words[r+7];for(;r<s;++r)this.words[r]^=t.words[r];if(t.words.length>this.words.length)for(var o=t.words.length;r<o;++r)this.words[r]=t.words[r];return this},t.prototype.new_change=function(t){return t.words.length>this.words.length?this.clone().change(t):t.clone().change(this)},t.prototype.change_size=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0,o=0;o<s;++o)r+=this.hammingWeight(this.words[o]^t.words[o]);for(var e=this.words.length>t.words.length?this:t,i=e.words.length;o<i;++o)r+=this.hammingWeight(e.words[o]);return r},t.prototype.toString=function(){return"{"+this.array().join(",")+"}"},t.prototype.union=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0;r+7<s;r+=8)this.words[r]|=t.words[r],this.words[r+1]|=t.words[r+1],this.words[r+2]|=t.words[r+2],this.words[r+3]|=t.words[r+3],this.words[r+4]|=t.words[r+4],this.words[r+5]|=t.words[r+5],this.words[r+6]|=t.words[r+6],this.words[r+7]|=t.words[r+7];for(;r<s;++r)this.words[r]|=t.words[r];if(this.words.length<t.words.length){this.resize((t.words.length<<5)-1);var o=t.words.length;for(r=s;r<o;++r)this.words[r]=t.words[r]}return this},t.prototype.new_union=function(s){var r=Object.create(t.prototype),o=Math.max(this.words.length,s.words.length);r.words=new Array(o);for(var e=Math.min(this.words.length,s.words.length),i=0;i+7<e;i+=8)r.words[i]=this.words[i]|s.words[i],r.words[i+1]=this.words[i+1]|s.words[i+1],r.words[i+2]=this.words[i+2]|s.words[i+2],r.words[i+3]=this.words[i+3]|s.words[i+3],r.words[i+4]=this.words[i+4]|s.words[i+4],r.words[i+5]=this.words[i+5]|s.words[i+5],r.words[i+6]=this.words[i+6]|s.words[i+6],r.words[i+7]=this.words[i+7]|s.words[i+7];for(;i<e;++i)r.words[i]=this.words[i]|s.words[i];var n=this.words.length;for(i=e;i<n;++i)r.words[i]=this.words[i];var h=s.words.length;for(i=e;i<h;++i)r.words[i]=s.words[i];return r},t.prototype.union_size=function(t){for(var s=Math.min(this.words.length,t.words.length),r=0,o=0;o<s;++o)r+=this.hammingWeight(this.words[o]|t.words[o]);if(this.words.length<t.words.length){var e=t.words.length;for(o=this.words.length;o<e;++o)r+=this.hammingWeight(0|t.words[o])}else for(e=this.words.length,o=t.words.length;o<e;++o)r+=this.hammingWeight(0|this.words[o]);return r};var s=t;class r{constructor(t){this.entities=new Map,this.mask=t}}class o{constructor(t,r){this.removed=!1,this.world=r,this.id=t,this.mask=new s,this.components=new Map}getComponent(t){return this.components.get(t.name)}addComponent(t){const s=this.world.registerComponent(t.constructor.name);return this.mask.add(s),this.components.set(t.constructor.name,t),this.world.updateQueries(this),this}removeComponent(t){const s=this.world.registerComponent(t.name);this.mask.remove(s),this.components.delete(t.name),this.world.updateQueries(this)}}class e{constructor(){this.nextId=1,this.components=new Map,this.entities=new Map,this.queries=new Map,this.systems=new Map,this.removedEntities=new Set}registerSystem(t){this.systems.set(t.constructor.name,t)}update(...t){for(const s of this.systems.values())s.update(...t);for(const t of this.removedEntities.values()){for(const s of this.queries.values())s.entities.delete(t.id);this.entities.delete(t.id)}this.removedEntities.clear()}updateQueries(t){for(const s of this.queries.values()){const r=s.mask.difference_size(t.mask),o=s.entities.has(t.id);o||0!==r?o&&0!==r&&s.entities.delete(t.id):s.entities.set(t.id,t)}}createQuery(t=[]){const o=new s;t.forEach((t=>o.add(this.registerComponent(t.name))));const e=o.toString();let i=this.queries.get(e);if(!i){i=new r(o);for(const t of this.entities.values())0===o.difference_size(t.mask)&&i.entities.set(t.id,t);this.queries.set(e,i)}return i}registerComponent(t){let s=this.components.get(t);return void 0===s&&(s=this.components.size,this.components.set(t,s)),s}removeEntity(t){t.removed=!0,this.removedEntities.add(t)}addEntity(t){const s=t||(this.nextId++).toString(),r=new o(s,this);return this.entities.set(s,r),r}}export{o as Entity,r as Query,e as World};
